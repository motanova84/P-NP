name: Lean 4 CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install elan
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH
    
    - name: Verify Lean installation
      run: |
        lean --version
        lake --version
    
    - name: Cache Lake packages
      uses: actions/cache@v3
      with:
        path: |
          .lake
          lake-packages
        key: ${{ runner.os }}-lake-${{ hashFiles('lakefile.lean', 'lean-toolchain') }}
        restore-keys: |
          ${{ runner.os }}-lake-
    
    - name: Build project
      run: lake build
    
    - name: Run tests (if any)
      run: |
        if [ -d "test" ]; then
          lake test
        else
          echo "No tests found, skipping"
        fi

  lint:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install elan
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH
    
    - name: Cache Lake packages
      uses: actions/cache@v3
      with:
        path: |
          .lake
          lake-packages
        key: ${{ runner.os }}-lake-${{ hashFiles('lakefile.lean', 'lean-toolchain') }}
    
    - name: Check for sorry statements
      run: |
        echo "Checking for sorry statements in source files..."
        SORRY_COUNT=$(grep -r "sorry" PNP/ | grep -v "-- To be proven" | wc -l || true)
        echo "Found $SORRY_COUNT sorry statements"
        if [ "$SORRY_COUNT" -gt 20 ]; then
          echo "Warning: Many sorry statements found. This is expected in initial development."
        fi
