name: Security and Reproducibility Verification

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Monday at 8am UTC
    - cron: '0 8 * * 1'

jobs:
  verify-environment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies from requirements.txt
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify ENV.lock integrity
        run: |
          echo "Verificando integridad de ENV.lock..."
          if [ -f ENV.lock.sha256 ]; then
            sha256sum -c ENV.lock.sha256 || {
              echo "ERROR: El hash de ENV.lock no coincide"
              echo "Esto podría indicar que el archivo fue modificado"
              exit 1
            }
            echo "✓ Hash de ENV.lock verificado correctamente"
          else
            echo "ADVERTENCIA: ENV.lock.sha256 no encontrado"
            echo "Generando hash de referencia..."
            sha256sum ENV.lock
          fi
      
      - name: Check for dependency conflicts
        run: |
          echo "Verificando conflictos de dependencias..."
          python -m pip check
      
      - name: Verify requirements.txt consistency
        run: |
          echo "Verificando que requirements.txt esté presente..."
          [ -f requirements.txt ] || {
            echo "ERROR: requirements.txt no encontrado"
            exit 1
          }
          echo "✓ requirements.txt encontrado"
          
          echo "Dependencias principales:"
          cat requirements.txt
      
      - name: Generate environment snapshot
        run: |
          echo "Generando snapshot del entorno..."
          python -m pip freeze > env_snapshot.txt
          echo "Total de paquetes instalados: $(wc -l < env_snapshot.txt)"
      
      - name: Upload environment snapshot as artifact
        uses: actions/upload-artifact@v4
        with:
          name: environment-snapshot
          path: env_snapshot.txt
          retention-days: 30
      
      - name: Security check - No secrets in code
        run: |
          echo "Verificando que no haya secretos comunes en el código..."
          # Buscar patrones comunes de secretos (simplificado)
          if grep -r -E "(password|secret|api_key|token)\s*=\s*['\"]" --include="*.py" --exclude-dir=".git" .; then
            echo "ADVERTENCIA: Se encontraron posibles secretos hardcodeados"
            echo "Por favor, revisa los archivos anteriores"
            exit 1
          else
            echo "✓ No se encontraron secretos hardcodeados obvios"
          fi
      
      - name: Verify documentation exists
        run: |
          echo "Verificando documentación de seguridad..."
          [ -f SEGURIDAD.md ] || {
            echo "ERROR: SEGURIDAD.md no encontrado"
            exit 1
          }
          echo "✓ SEGURIDAD.md encontrado"
          
          [ -f "RESUMEN DE SEGURIDAD.md" ] || {
            echo "ERROR: RESUMEN DE SEGURIDAD.md no encontrado"
            exit 1
          }
          echo "✓ RESUMEN DE SEGURIDAD.md encontrado"
      
      - name: Summary
        run: |
          echo "================================================"
          echo "  Verificación de Seguridad y Reproducibilidad"
          echo "================================================"
          echo ""
          echo "✓ ENV.lock verificado"
          echo "✓ Dependencias consistentes"
          echo "✓ Sin conflictos de dependencias"
          echo "✓ Documentación de seguridad presente"
          echo "✓ Sin secretos hardcodeados detectados"
          echo ""
          echo "El proyecto cumple con los estándares de seguridad y reproducibilidad."
